# Vue Virtual Tree 技术实现规范

## 项目概述

基于 `vue-virtual-scroller@next` 实现一个高性能的 Vue 3 虚拟树列表组件库，功能参照 Element Plus Tree 组件。

## 技术栈

- **框架**: Vue 3 (Composition API)
- **虚拟滚动**: vue-virtual-scroller@next
- **包管理工具**: pnpm
- **构建工具**: Vite
- **类型支持**: TypeScript
- **样式方案**: CSS/SCSS (可选支持 CSS Modules)

## 核心功能需求

### 1. 基础功能
- [x] 树形结构展示
- [x] 节点展开/折叠
- [x] 虚拟滚动（支持大量数据）
- [x] 节点点击事件

### 2. 选择功能
- [x] 单选模式
- [x] 多选模式（复选框）
- [x] 节点选中状态管理
- [x] 父子节点关联选择

### 3. 数据功能
- [x] 懒加载节点
- [x] 节点过滤/搜索
- [x] 默认展开节点
- [x] 默认选中节点

### 4. 交互功能
- [x] 自定义节点内容（插槽）
- [x] 自定义节点类名
- [x] 节点拖拽排序
- [x] 手风琴模式（同级节点互斥展开）

### 5. 高级功能
- [x] 节点禁用
- [x] 节点图标自定义
- [x] 节点加载状态
- [x] 空状态展示

## 技术实现思路

### 1. 数据扁平化处理

由于虚拟滚动需要线性列表，需要将树形结构扁平化为线性数组：

```typescript
interface FlatTreeNode {
  id: string | number
  data: any // 原始节点数据
  level: number // 节点层级
  parentId: string | number | null
  isExpanded: boolean
  isVisible: boolean
  children?: FlatTreeNode[]
  // ... 其他状态
}
```

**扁平化算法**：
- 递归遍历树形数据
- 根据展开状态决定是否包含子节点
- 维护节点的层级、父子关系等信息
- 支持懒加载时动态添加节点

### 2. 虚拟滚动集成

使用 `vue-virtual-scroller@next` 的 `DynamicScroller` 或 `RecycleScroller`：

- **DynamicScroller**: 适合节点高度不固定的场景
- **RecycleScroller**: 适合节点高度固定的场景（性能更好）

**实现要点**：
- 将扁平化后的数组作为数据源
- 计算每个节点的实际高度（动态高度场景）
- 处理滚动位置与展开/折叠的联动

### 3. 状态管理

使用 Vue 3 Composition API 管理组件状态：

```typescript
const useTreeState = () => {
  const expandedKeys = ref<Set<string | number>>(new Set())
  const checkedKeys = ref<Set<string | number>>(new Set())
  const selectedKey = ref<string | number | null>(null)
  // ...
}
```

### 4. 性能优化

- **虚拟滚动**: 只渲染可见区域的节点
- **计算属性缓存**: 扁平化结果使用 computed 缓存
- **事件防抖**: 滚动、过滤等操作使用防抖
- **按需更新**: 只更新变化的节点，避免全量重渲染

### 5. API 设计

参考 Element Plus Tree 的 API 设计：

**Props**:
- `data`: 树形数据
- `props`: 数据字段映射配置
- `show-checkbox`: 是否显示复选框
- `check-strictly`: 是否严格遵循父子不关联
- `default-expand-all`: 是否默认展开所有节点
- `expand-on-click-node`: 是否点击节点展开
- `lazy`: 是否懒加载
- `load`: 懒加载方法
- `filter-node-method`: 节点过滤方法
- `accordion`: 是否手风琴模式
- `draggable`: 是否可拖拽
- `allow-drop`: 拖拽时判断是否允许放置
- `allow-drag`: 拖拽时判断节点是否允许拖拽

**Events**:
- `node-click`: 节点点击
- `node-check`: 节点复选框点击
- `node-expand`: 节点展开
- `node-collapse`: 节点折叠
- `current-change`: 当前选中节点变化
- `node-drag-start/enter/leave/over/end/drop`: 拖拽相关事件

**Methods**:
- `getCheckedNodes`: 获取选中的节点
- `getCheckedKeys`: 获取选中的节点 key
- `setCheckedNodes`: 设置选中的节点
- `setCheckedKeys`: 设置选中的节点 key
- `getCurrentNode`: 获取当前选中节点
- `setCurrentNode`: 设置当前选中节点
- `filter`: 过滤节点
- `getNode`: 根据 key 获取节点
- `remove`: 删除节点
- `append`: 追加节点
- `insertBefore`: 在节点前插入
- `insertAfter`: 在节点后插入

**Slots**:
- `default`: 自定义节点内容
- `empty`: 空状态内容

## 项目结构

```
vue-virtual-tree/
├── packages/
│   └── vue-virtual-tree/
│       ├── src/
│       │   ├── components/
│       │   │   ├── VirtualTree.vue          # 主组件
│       │   │   ├── TreeNode.vue            # 树节点组件
│       │   │   └── TreeCheckbox.vue        # 复选框组件
│       │   ├── composables/
│       │   │   ├── useTreeData.ts          # 数据扁平化逻辑
│       │   │   ├── useTreeState.ts         # 状态管理
│       │   │   ├── useTreeSelection.ts     # 选择逻辑
│       │   │   ├── useTreeExpand.ts        # 展开/折叠逻辑
│       │   │   ├── useTreeFilter.ts        # 过滤逻辑
│       │   │   └── useTreeDrag.ts          # 拖拽逻辑
│       │   ├── types/
│       │   │   └── index.ts                # 类型定义
│       │   ├── utils/
│       │   │   ├── tree.ts                 # 树形数据处理工具
│       │   │   └── dom.ts                  # DOM 工具函数
│       │   └── index.ts                    # 入口文件
│       ├── style/
│       │   └── index.scss                  # 样式文件
│       ├── package.json
│       └── vite.config.ts
├── playground/
│   ├── src/
│   │   ├── App.vue
│   │   └── main.ts
│   ├── index.html
│   └── vite.config.ts
├── package.json
├── pnpm-workspace.yaml
├── tsconfig.json
└── README.md
```

## 构建配置

### Vite 配置要点

- 使用 `library` 模式构建
- 配置外部依赖（Vue、vue-virtual-scroller）
- 支持 TypeScript
- 生成类型声明文件
- 支持按需导入

### Package.json 配置

- `main`: CommonJS 入口
- `module`: ES Module 入口
- `types`: TypeScript 类型声明
- `exports`: 支持多种导入方式
- `peerDependencies`: Vue 3、vue-virtual-scroller

## 开发规范

1. **代码风格**: 使用 ESLint + Prettier
2. **类型安全**: 全面使用 TypeScript
3. **组件设计**: 使用 Composition API
4. **测试**: 使用 Vitest 进行单元测试（可选）
5. **文档**: 使用 VitePress 或类似工具生成文档（可选）

## 依赖管理

### 核心依赖
- `vue`: ^3.3.0
- `vue-virtual-scroller`: next (Vue 3 版本)

### 开发依赖
- `vite`: ^5.0.0
- `typescript`: ^5.0.0
- `@vitejs/plugin-vue`: ^5.0.0
- `pnpm`: ^8.0.0

## 发布计划

1. **v0.1.0**: 基础功能（展示、展开/折叠、虚拟滚动）
2. **v0.2.0**: 选择功能（单选、多选）
3. **v0.3.0**: 数据功能（懒加载、过滤）
4. **v0.4.0**: 交互功能（拖拽、自定义内容）
5. **v1.0.0**: 完整功能，稳定版本

